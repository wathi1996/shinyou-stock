<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบจัดการสต็อก Shinyou Shabu</title>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyimeiJRuZn6tRwLPIAOfiKMHwuy7WkL8Bu6ppvJOSpMwSdyX7BAABf9h_zPAyld0_5VQ/exec";

    async function loadProductsForAllTables() {
      try {
        const res = await fetch(`${API_URL}?action=getProducts`);
        const data = await res.json();
        renderTable("stock-table-body", data, false);
        renderTable("stockinTable", data, true);
        renderTable("stockoutTable", data, true);
        renderTable("adjust-table-body", data, true);
      } catch (err) {
        console.error('loadProducts error', err);
      }
    }

    function renderTable(targetId, data, withInput) {
      const tbody = document.getElementById(targetId);
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const row = `<tr>
          <td>${index + 1}</td>
          <td>${item.name}</td>
          <td>${item.supplier}</td>
          <td>${item.stock}</td>
          <td>${item.unit}</td>
          ${withInput ? `<td><input type="number" class="form-control" name="qty" data-name="${item.name}" /></td>` : ""}
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    async function submitForm(action, tableId, dateInputId) {
  const date = document.getElementById(dateInputId).value;
  if (!date) return alert("⛔ กรุณาเลือกวันที่");

  const rows = document.getElementById(tableId).querySelectorAll("tr");
  const records = [];

  rows.forEach(row => {
    const input = row.querySelector("input[name='qty']");
    if (input && input.value && parseFloat(input.value) > 0) {
      const name = input.dataset.name;
      const qty = parseFloat(input.value);

      const tds = row.querySelectorAll("td");
      const supplier = tds[2]?.textContent?.trim() ?? "";
      const unit = tds[4]?.textContent?.trim() ?? "";

      let qtyLabel = "จำนวน";
      if (action === "submitStockIn") qtyLabel = "จำนวนเข้า";
      else if (action === "submitStockOut") qtyLabel = "จำนวนเบิก";
      else if (action === "submitAdjustStock") qtyLabel = "จำนวนปรับ";

      records.push({
        "วันที่": date,
        "ชื่อสินค้า": name,
        "Supplier": supplier,
        [qtyLabel]: qty,
        "หน่วย": unit
      });
    }
  });

  if (records.length === 0) return alert("⛔ กรุณาใส่จำนวนสินค้าที่ต้องการบันทึก");

  try {
    const res = await fetch(API_URL + "?action=" + action, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(records)
    });

    const text = await res.text();
    if (text.includes("Success")) {
      alert("✅ บันทึกสำเร็จ");
      loadProductsForAllTables();
    } else {
      throw new Error(text);
    }
  } catch (err) {
    console.error(err);
    alert("❌ เกิดข้อผิดพลาด");
  }
}

    document.addEventListener("DOMContentLoaded", () => {
      loadProductsForAllTables();
      document.querySelectorAll(".nav-link").forEach(link => {
        link.addEventListener("click", () => {
          document.querySelectorAll(".page").forEach(p => p.classList.add("d-none"));
          document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
          const target = link.dataset.target;
          document.getElementById(target).classList.remove("d-none");
          link.classList.add("active");
        });
      });
    });
  <script>
  async function submitForm(action, tableId, dateInputId) {
    const date = document.getElementById(dateInputId).value;
    if (!date) return alert("⛔ กรุณาเลือกวันที่");

    const rows = document.getElementById(tableId).querySelectorAll("tr");
    const records = [];

    rows.forEach(row => {
      const input = row.querySelector("input[name='qty']");
      if (input && input.value && parseFloat(input.value) > 0) {
        const name = input.dataset.name;
        const qty = parseFloat(input.value);

        const tds = row.querySelectorAll("td");
        const supplier = tds[2]?.textContent?.trim() ?? "";
        const unit = tds[4]?.textContent?.trim() ?? "";

        let qtyLabel = "จำนวน";
        if (action === "submitStockIn") qtyLabel = "จำนวนเข้า";
        else if (action === "submitStockOut") qtyLabel = "จำนวนเบิก";
        else if (action === "submitAdjustStock") qtyLabel = "จำนวนปรับ";

        records.push({
          "วันที่": date,
          "ชื่อสินค้า": name,
          "Supplier": supplier,
          [qtyLabel]: qty,
          "หน่วย": unit
        });
      }
    });

    if (records.length === 0) return alert("⛔ กรุณาใส่จำนวนสินค้าที่ต้องการบันทึก");

    try {
      const res = await fetch(API_URL + "?action=" + action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(records)
      });

      const text = await res.text();
      if (text.includes("Success")) {
        alert("✅ บันทึกสำเร็จ");
        loadProductsForAllTables();
      } else {
        throw new Error(text);
      }
    } catch (err) {
      console.error(err);
      alert("❌ เกิดข้อผิดพลาด");
    }
  }
</script>
</body>
</html>
