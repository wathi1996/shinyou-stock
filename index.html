<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å Shinyou Shabu</title>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyimeiJRuZn6tRwLPIAOfiKMHwuy7WkL8Bu6ppvJOSpMwSdyX7BAABf9h_zPAyld0_5VQ/exec";

    async function loadProductsForAllTables() {
      try {
        const res = await fetch(`${API_URL}?action=getProducts`);
        const data = await res.json();
        renderTable("stock-table-body", data, false);
        renderTable("stockinTable", data, true);
        renderTable("stockoutTable", data, true);
        renderTable("adjust-table-body", data, true);
      } catch (err) {
        console.error('loadProducts error', err);
      }
    }

    function renderTable(targetId, data, withInput) {
      const tbody = document.getElementById(targetId);
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const row = `<tr>
          <td>${index + 1}</td>
          <td>${item.name}</td>
          <td>${item.supplier}</td>
          <td>${item.stock}</td>
          <td>${item.unit}</td>
          ${withInput ? `<td><input type="number" class="form-control" name="qty" data-name="${item.name}" /></td>` : ""}
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    async function submitForm(action, tableId, dateInputId) {
  const date = document.getElementById(dateInputId).value;
  if (!date) return alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

  const rows = document.getElementById(tableId).querySelectorAll("tr");
  const records = [];

  rows.forEach(row => {
    const input = row.querySelector("input[name='qty']");
    if (input && input.value && parseFloat(input.value) > 0) {
      const name = input.dataset.name;
      const qty = parseFloat(input.value);

      const tds = row.querySelectorAll("td");
      const supplier = tds[2]?.textContent?.trim() ?? "";
      const unit = tds[4]?.textContent?.trim() ?? "";

      let qtyLabel = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô";
      if (action === "submitStockIn") qtyLabel = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤";
      else if (action === "submitStockOut") qtyLabel = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å";
      else if (action === "submitAdjustStock") qtyLabel = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö";

      records.push({
        "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": date,
        "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": name,
        "Supplier": supplier,
        [qtyLabel]: qty,
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit
      });
    }
  });

  if (records.length === 0) return alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

  try {
    const res = await fetch(API_URL + "?action=" + action, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(records)
    });

    const text = await res.text();
    if (text.includes("Success")) {
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      loadProductsForAllTables();
    } else {
      throw new Error(text);
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
}

    document.addEventListener("DOMContentLoaded", () => {
      loadProductsForAllTables();
      document.querySelectorAll(".nav-link").forEach(link => {
        link.addEventListener("click", () => {
          document.querySelectorAll(".page").forEach(p => p.classList.add("d-none"));
          document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
          const target = link.dataset.target;
          document.getElementById(target).classList.remove("d-none");
          link.classList.add("active");
        });
      });
    });
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; }
    .nav-link { margin-right: 10px; cursor: pointer; padding: 6px 12px; background: #eee; border-radius: 4px; display: inline-block; }
    .nav-link.active { background: #c33; color: #fff; }
    .d-none { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input[type="number"] { width: 80px; }
  </style>
</head>
<body>
  <h2>üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å Shinyou Shabu</h2>
  <nav>
    <span class="nav-link active" data-target="page-stock">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
    <span class="nav-link" data-target="tab-stockin">‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    <span class="nav-link" data-target="tab-stockout">‚ûñ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    <span class="nav-link" data-target="page-adjust">üìù ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
  </nav>

  <div id="page-stock" class="page">
    <h3>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
    <table>
      <thead><tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>Supplier</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th></tr></thead>
      <tbody id="stock-table-body"></tbody>
    </table>
  </div>

  <div id="tab-stockin" class="page d-none">
    <h5>‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</h5>
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: <input type="date" id="date-in"></label>
    <table>
      <thead>
        <tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>Supplier</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö</th></tr>
      </thead>
      <tbody id="stockinTable"></tbody>
    </table>
    <button onclick="submitForm('submitStockIn', 'stockinTable', 'date-in')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
  </div>

  <div id="tab-stockout" class="page d-none">
    <h5>‚ûñ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</h5>
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å: <input type="date" id="date-out"></label>
    <table>
      <thead>
        <tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>Supplier</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å</th></tr>
      </thead>
      <tbody id="stockoutTable"></tbody>
    </table>
    <button onclick="submitForm('submitStockOut', 'stockoutTable', 'date-out')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>
  </div>

  <div id="page-adjust" class="page d-none">
    <h3>üìù ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö: <input type="date" id="date-adjust"></label>
    <table>
      <thead>
        <tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>Supplier</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</th></tr>
      </thead>
      <tbody id="adjust-table-body"></tbody>
    </table>
    <button onclick="submitForm('submitAdjustStock', 'adjust-table-body', 'date-adjust')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö</button>
  </div>
  <script>
  async function submitForm(action, tableId, dateInputId) {
    const date = document.getElementById(dateInputId).value;
    if (!date) return alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

    const rows = document.getElementById(tableId).querySelectorAll("tr");
    const records = [];

    rows.forEach(row => {
      const input = row.querySelector("input[name='qty']");
      if (input && input.value && parseFloat(input.value) > 0) {
        const name = input.dataset.name;
        const qty = parseFloat(input.value);

        const tds = row.querySelectorAll("td");
        const supplier = tds[2]?.textContent?.trim() ?? "";
        const unit = tds[4]?.textContent?.trim() ?? "";

        records.push({
          "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": date,
          "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": name,
          "Supplier": supplier,
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤": qty,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit
        });
      }
    });

    if (records.length === 0) return alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

    try {
      const res = await fetch(API_URL + "?action=" + action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(records)
      });

      const text = await res.text();
      if (text.includes("Success")) {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadProductsForAllTables();
      } else {
        throw new Error(text);
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    }
  }
</script>
</body>
</html>
